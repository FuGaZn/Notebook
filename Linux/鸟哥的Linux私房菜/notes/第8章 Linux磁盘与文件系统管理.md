## EXT2文件系统

### 磁盘&分区

扇区Sector是最小的**物理存储**单位，每个扇区512字节。

将扇区组成一个圆，就是柱面Cylinder，柱面是分区partition的最小单位。

第一个扇区最重要，里面有硬盘主引导记录MBR和分区表。MBR占据446字节，分区表占据64字节

对分区的一些限制：

- 主分区和逻辑分区最多有四个
- 扩展分区最多有一个
- 逻辑分区是由扩展分区切割出来的分区
- 能够被格式化后作为数据访问的分区是主分区和逻辑分区，扩展分区无法格式化
- Linux中，IDE硬盘最多59个逻辑分区，SATA则最多11个逻辑分区



### 文件系统特性

EXT2文件系统是索引式文件系统，

文件系统将文件的不同数据存放在不同的块中，权限和属性放在inode中，实际数据放在data block中。另外，还有一个super block会记录整个文件系统的整体信息。

- super block: 文件系统的整体信息，包括inode/block的总量、使用量、剩余量，以及文件系统的格式等
- inode: 记录文件的权限、属性。一个文件占用一个inode，同时记录该文件的数据所在block的号码
- block: 文件实际内容。文件太大可以占用多个block

<br>

Ext2文件系统在格式化的时候基本上是区分为多个块组的，每个块组都有独立的inode/block/superblock系统。![](../img/8-3.jpg)

Ext2中，所支持的data block大小由1kb，2kb，4kb三种。在格式化的时候block的大小就规定了。

每个block最多只能放置一个文件的数据。

<br>

inode记录的文件数据：

- 文件访问模式 (r/w/x)
- 文件所有者和组
- 文件大小
- 创建或状态改变时间ctime
- 读取时间atime
- 修改时间mtime
- 定义文件特性的标志flag
- 该文件真正内容的指向pointer

inode的一些特点：

- 固定大小128字节
- 每个文件仅会占用一个inode
- 文件系统能创建的文件数量和inode的数量有关

<br>

块对应表(block bitmap)：根据块对应表，可以快速找到可供使用的block

inode对应表：功能和块对应表类似



<br>

读取文件的流程![](../img/8.4.jpg)

新增文件的流程：

- 先确定用户对于欲添加文件袋目录是否具有w与x的权限，若有的话才能添加
- 根据inode bitmap找到没有使用过的inode号码，将文件的权限、属性写入
- 根据block bitmap找到没有使用过的block号码，将实际数据写入block中，并更新inode的block pointer
- 将刚才写入的inode和block数据同步更新inode bitmap和block bitmap，并更新super block内容

<br>



异步处理：内存中的文件由两种状态：clean和dirty。

当系统加载一个文件到内存时，如果没有被更改，默认为clean；如果文件被更改了，此时内存中的数据会被设为dirty。系统会不定时将设置为dirty的数据写回磁盘，以保证磁盘和内存的数据一致性。



